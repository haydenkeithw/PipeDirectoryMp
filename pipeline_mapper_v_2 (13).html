<!DOCTYPE html>
<html>
<head>
  <title>PipeDirectoryMp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .toolbar button {
      cursor: pointer;
      padding: 5px 10px;
    }
    .form-popup {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
    }
    input, select, textarea { width: 100%; margin: 5px 0; padding: 5px; }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="panTool">üñêÔ∏è Pan</button>
    <button id="pinTool">‚ûï Add Pin</button>
    <input type="text" id="searchBox" placeholder="Search location...">
    <button id="searchButton">üîç</button>
  </div>
  <div id="map"></div>

  <div class="form-popup" id="infoForm">
    <h4>Pipe Segment Info</h4>
    <label>Pipe Size:</label>
    <input type="text" id="pipeSize">
    <label>Pipe Lot #:</label>
    <input type="text" id="pipeLot">
    <label>Install Method:</label>
    <select id="installMethod">
      <option value="">Select</option>
      <option value="bore">Bore</option>
      <option value="trench">Trench</option>
    </select>
    <label>Tracer Wire Size:</label>
    <input type="text" id="wireSize">
    <label>Notes:</label>
    <textarea id="notes"></textarea>
    <label>Upload Media:</label>
    <input type="file" id="mediaUpload" accept="image/*,video/*">
    <div id="mediaPreview"></div>
    <button onclick="saveInfo()">Save</button>
    <button onclick="closeForm()">Close</button>
    <button onclick="exportData()">üì§ Export</button>
    <input type="file" id="importFile" accept="application/json">
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([30.4, -89.0], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);

    let isPlacingPins = false;
    let pinToolBtn = document.getElementById('pinTool');
    let panToolBtn = document.getElementById('panTool');
    let pins = [];
    let segments = [];
    let segmentData = {};
    let selectedSegmentKey = null;

    pinToolBtn.onclick = () => { isPlacingPins = true; };
    panToolBtn.onclick = () => { isPlacingPins = false; };

    function saveToStorage() {
      const pinCoords = pins.map(p => p.getLatLng());
      localStorage.setItem("mapPins", JSON.stringify(pinCoords));
      localStorage.setItem("segmentData", JSON.stringify(segmentData));
    }

    function loadFromStorage() {
      const savedPins = JSON.parse(localStorage.getItem("mapPins") || "[]");
      const savedData = JSON.parse(localStorage.getItem("segmentData") || "{}");
      segmentData = savedData;

      savedPins.forEach(latlng => {
        const marker = L.marker(latlng, { draggable: true }).addTo(map);
        marker.on('drag', () => { redrawSegments(); saveToStorage(); });
        marker.on('contextmenu', () => {
          map.removeLayer(marker);
          pins = pins.filter(p => p !== marker);
          redrawSegments();
          saveToStorage();
        });
        pins.push(marker);
      });
      redrawSegments();
    }

    map.on('click', (e) => {
      if (!isPlacingPins) return;
      const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
      marker.on('drag', () => { redrawSegments(); saveToStorage(); });
      marker.on('contextmenu', () => {
        map.removeLayer(marker);
        pins = pins.filter(p => p !== marker);
        redrawSegments();
        saveToStorage();
      });
      pins.push(marker);
      redrawSegments();
      saveToStorage();
    });

    function redrawSegments() {
      segments.forEach(seg => map.removeLayer(seg.line));
      segments = [];
      for (let i = 0; i < pins.length - 1; i++) {
        const latlngs = [pins[i].getLatLng(), pins[i+1].getLatLng()];
        const key = `${latlngs[0].lat},${latlngs[0].lng}-${latlngs[1].lat},${latlngs[1].lng}`;
        const line = L.polyline(latlngs, { color: 'yellow' }).addTo(map);
        line.on('click', () => {
          selectedSegmentKey = key;
          openForm();
        });
        segments.push({ line, key });
      }
    }

    function openForm() {
      const data = segmentData[selectedSegmentKey] || {};
      document.getElementById('pipeSize').value = data.pipeSize || "";
      document.getElementById('pipeLot').value = data.pipeLot || "";
      document.getElementById('installMethod').value = data.installMethod || "";
      document.getElementById('wireSize').value = data.wireSize || "";
      document.getElementById('notes').value = data.notes || "";
      document.getElementById('mediaUpload').value = "";

      const preview = document.getElementById('mediaPreview');
      preview.innerHTML = "";
      if (data.media) {
        const media = document.createElement(data.media.startsWith('data:video') ? 'video' : 'img');
        media.src = data.media;
        if (data.media.startsWith('data:video')) media.controls = true;
        media.style.maxWidth = '100%';
        preview.appendChild(media);
      }

      document.getElementById('infoForm').style.display = 'block';
    }

    function closeForm() {
      document.getElementById('infoForm').style.display = 'none';
    }

    function saveInfo() {
      if (!selectedSegmentKey) return;
      const fileInput = document.getElementById('mediaUpload');
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          updateSegmentInfo(evt.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        updateSegmentInfo(segmentData[selectedSegmentKey]?.media);
      }
    }

    function updateSegmentInfo(mediaData) {
      segmentData[selectedSegmentKey] = {
        pipeSize: document.getElementById('pipeSize').value,
        pipeLot: document.getElementById('pipeLot').value,
        installMethod: document.getElementById('installMethod').value,
        wireSize: document.getElementById('wireSize').value,
        notes: document.getElementById('notes').value,
        media: mediaData || null
      };
      closeForm();
      saveToStorage();
    }

    document.getElementById('searchButton').addEventListener('click', async () => {
      const query = document.getElementById('searchBox').value;
      if (!query) return alert("Enter a location to search");

      try {
        const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data.features.length > 0) {
          const coords = data.features[0].geometry.coordinates;
          const latlng = [coords[1], coords[0]];
          map.setView(latlng, 16);
        } else {
          alert("Location not found.");
        }
      } catch (err) {
        console.error(err);
        alert("Error searching location.");
      }
    });

    function exportData() {
      const data = {
        pins: pins.map(p => p.getLatLng()),
        segmentData
      };
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pipeline_data.json';
      a.click();
    }

    document.getElementById('importFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const content = JSON.parse(evt.target.result);
        pins.forEach(p => map.removeLayer(p));
        pins = [];
        segmentData = content.segmentData || {};
        content.pins.forEach(latlng => {
          const marker = L.marker(latlng, { draggable: true }).addTo(map);
          marker.on('drag', () => { redrawSegments(); saveToStorage(); });
          marker.on('contextmenu', () => {
            map.removeLayer(marker);
            pins = pins.filter(p => p !== marker);
            redrawSegments();
            saveToStorage();
          });
          pins.push(marker);
        });
        redrawSegments();
        saveToStorage();
      };
      reader.readAsText(file);
    });

    loadFromStorage();
  </script>
</body>
</html>
