<!DOCTYPE html>
<html>
<head>
  <title>PipeDirectoryMp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .toolbar button {
      cursor: pointer;
      padding: 5px 10px;
    }
    .form-popup {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .context-menu {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 2000;
      display: none;
    }
    .context-menu button {
      display: block;
      width: 100%;
      padding: 8px 10px;
      border: none;
      background: white;
      cursor: pointer;
    }
    .context-menu button:hover {
      background: #eee;
    }
    input, select, textarea { width: 100%; margin: 5px 0; padding: 5px; }
    .leaflet-marker-icon.remove-icon {
      background: red;
      border-radius: 50%;
      width: 10px;
      height: 10px;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="panTool">üñêÔ∏è Pan</button>
    <button id="pinTool">‚ûï Add Pin</button>
    <input type="text" id="searchBox" placeholder="Search location...">
  </div>
  <div id="map"></div>
  <div class="form-popup" id="formPopup" style="display:none;">
    <h4>Pipe Segment Info</h4>
    <form id="pipeForm">
      <input type="text" placeholder="Footage (ft)" id="footage" required>
      <input type="text" placeholder="Pipe Size" id="pipeSize">
      <input type="text" placeholder="Lot Number" id="lotNumber">
      <select id="method">
        <option value="Trench">Trench</option>
        <option value="Bore">Bore</option>
      </select>
      <input type="text" placeholder="Tracer Wire Size" id="wireSize">
      <textarea placeholder="Notes" id="notes"></textarea>
      <input type="file" id="media" multiple accept="image/*,video/*">
      <button type="submit">Save Entry</button>
    </form>
  </div>
  <div class="context-menu" id="contextMenu">
    <button id="editPin">üìù Edit Pin</button>
    <button id="deletePin">‚ùå Delete Pin</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    const map = L.map('map').setView([30.4, -89.0], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);

    const geocoderControl = L.Control.geocoder({ defaultMarkGeocode: false }).addTo(map);

    document.getElementById('searchBox').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        geocoderControl.options.geocoder.geocode(this.value, function(results) {
          if (results.length > 0) {
            const r = results[0];
            map.setView(r.center, 16);
            L.marker(r.center).addTo(map).bindPopup(r.name).openPopup();
          } else {
            alert('Location not found');
          }
        });
      }
    });

    let mode = 'pan';
    let points = [], markers = [], segments = [], currentMarker = null;

    document.getElementById('panTool').onclick = () => mode = 'pan';
    document.getElementById('pinTool').onclick = () => mode = 'add';

    const contextMenu = document.getElementById('contextMenu');
    let currentContextLatLng = null;

    function showContextMenu(marker, event) {
      currentMarker = marker;
      contextMenu.style.display = 'block';
      contextMenu.style.left = `${event.containerPoint.x}px`;
      contextMenu.style.top = `${event.containerPoint.y}px`;
    }

    function hideContextMenu() {
      contextMenu.style.display = 'none';
    }

    document.getElementById('deletePin').onclick = () => {
      if (currentMarker) {
        map.removeLayer(currentMarker);
        markers = markers.filter(m => m !== currentMarker);
        points = points.filter(p => p !== currentMarker.getLatLng());
        hideContextMenu();
      }
    };

    document.getElementById('editPin').onclick = () => {
      if (currentMarker) {
        currentMarker.dragging.enable();
        alert("Pin is now editable. Drag it to a new location.");
        hideContextMenu();
      }
    };

    map.on('click', function() { hideContextMenu(); });

    function createMarker(latlng) {
      const marker = L.marker(latlng, { draggable: true }).addTo(map);

      marker.on('contextmenu', function(e) {
        showContextMenu(marker, e);
      });

      markers.push(marker);
      points.push(latlng);

      if (points.length === 2) {
        const line = L.polyline(points, { color: 'yellow' }).addTo(map);
        segments.push({ line, start: points[0], end: points[1] });
        openForm(points[0], points[1]);
        points = [];
      }
    }

    map.on('click', function(e) {
      if (mode === 'add') {
        createMarker(e.latlng);
      }
    });

    function openForm(start, end) {
      const formPopup = document.getElementById("formPopup");
      formPopup.style.display = 'block';

      document.getElementById("pipeForm").onsubmit = function(e) {
        e.preventDefault();
        const entry = {
          start,
          end,
          footage: document.getElementById("footage").value,
          pipeSize: document.getElementById("pipeSize").value,
          lotNumber: document.getElementById("lotNumber").value,
          method: document.getElementById("method").value,
          wireSize: document.getElementById("wireSize").value,
          notes: document.getElementById("notes").value,
          media: document.getElementById("media").files
        };
        console.log("Saved entry:", entry);
        alert("Segment saved. Check console for details.");
        formPopup.style.display = 'none';
        document.getElementById("pipeForm").reset();
      };
    }
  </script>
</body>
</html>
